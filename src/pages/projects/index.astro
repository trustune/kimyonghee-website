---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

const allProjects = await getCollection('projects');

const projects = allProjects
  .map(project => ({
    id: project.slug,
    ...project.data,
  }))
  .sort((a, b) => new Date(b.date) - new Date(a.date));

const categories = [...new Set(projects.map(p => p.category))];
const years = [...new Set(projects.map(p => new Date(p.date).getFullYear()))].sort((a, b) => b - a);
---

<BaseLayout title="Projects - Yonghee Kim" description="Research projects and data analysis work">
  <div class="projects-container">
    <header class="page-header">
      <h1 class="page-title">Research Projects</h1>

      <div class="stats-row">
        <div class="stat-item">
          <span class="stat-number">{projects.length}</span>
          <span class="stat-label">Projects</span>
        </div>
        <div class="stat-item">
          <span class="stat-number">{categories.length}</span>
          <span class="stat-label">Categories</span>
        </div>
        <div class="stat-item">
          <span class="stat-number">{years[0]}-{years[years.length-1]}</span>
          <span class="stat-label">Period</span>
        </div>
      </div>
    </header>

    <div class="controls-bar">
      <div class="search-box">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input
          type="text"
          id="searchInput"
          class="search-input"
          placeholder="Search projects..."
        />
      </div>

      <select id="categoryFilter" class="filter-select">
        <option value="all">All Categories</option>
        {categories.map(cat => (
          <option value={cat}>{cat}</option>
        ))}
      </select>

      <select id="yearFilter" class="filter-select">
        <option value="all">All Years</option>
        {years.map(year => (
          <option value={year}>{year}</option>
        ))}
      </select>

      <button id="resetBtn" class="reset-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="1 4 1 10 7 10"></polyline>
          <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
        </svg>
        <span>Reset</span>
      </button>
    </div>

    <div class="projects-list" id="projectsList">
      {projects.map((project) => (
        <article
          class="project-item"
          data-category={project.category}
          data-year={new Date(project.date).getFullYear()}
          data-date={project.date}
          data-search-text={`${project.title} ${project.title_en} ${project.subtitle} ${project.subtitle_en} ${project.description} ${project.description_en} ${project.summary} ${project.tags?.join(' ') || ''}`}
        >
          <div class="project-main">
            <div class="project-header-row">
              <div class="project-meta-left">
                <span class="category-badge">{project.category}</span>
                {project.featured && (
                  <span class="featured-badge">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    Featured
                  </span>
                )}
              </div>
              <div class="project-date">
                {new Date(project.date).toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'short',
                  day: 'numeric'
                })}
              </div>
            </div>

            <h3 class="project-title">
              <a href={`/projects/${project.id}`}>
                {project.title_en || project.title}
              </a>
            </h3>

            {(project.subtitle_en || project.subtitle) && (
              <p class="project-subtitle">
                {project.subtitle_en || project.subtitle}
              </p>
            )}

            <p class="project-description">
              {project.description_en || project.description}
            </p>

            {project.conference && (
              <div class="conference-info">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                  <circle cx="12" cy="10" r="3"></circle>
                </svg>
                {project.conference_en || project.conference}
              </div>
            )}

            <div class="project-footer">
              <div class="tags-row">
                {project.tags && project.tags.slice(0, 4).map(tag => (
                  <span class="tag">{tag}</span>
                ))}
              </div>

              <a href={`/projects/${project.id}`} class="view-link">
                View Details
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </a>
            </div>
          </div>
        </article>
      ))}
    </div>

    <div id="noResults" class="no-results" style="display: none;">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
        <line x1="11" y1="8" x2="11" y2="14"></line>
        <line x1="8" y1="11" x2="14" y2="11"></line>
      </svg>
      <p>No projects found matching your criteria.</p>
      <button id="resetFromEmpty" class="reset-link">
        Clear filters
      </button>
    </div>
  </div>
</BaseLayout>

<style>
  .projects-container {
    max-width: var(--container-max);
    margin: 0 auto;
    padding: var(--space-8) var(--space-6);
  }

  .page-header {
    margin-bottom: var(--space-8);
  }

  .page-title {
    font-family: var(--font-serif);
    font-size: var(--step-4);
    color: var(--color-text);
    margin-bottom: var(--space-6);
    font-weight: 400;
  }

  .stats-row {
    display: flex;
    gap: var(--space-8);
    padding: var(--space-4) 0;
    border-bottom: 1px solid var(--color-border);
  }

  .stat-item {
    display: flex;
    align-items: baseline;
    gap: var(--space-2);
  }

  .stat-number {
    font-size: var(--step-2);
    font-weight: 700;
    color: var(--color-accent);
    font-family: var(--font-sans);
  }

  .stat-label {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    font-weight: 500;
  }

  .controls-bar {
    display: flex;
    gap: var(--space-3);
    margin-bottom: var(--space-8);
    flex-wrap: wrap;
  }

  .search-box {
    flex: 1;
    min-width: 250px;
    position: relative;
  }

  .search-icon {
    position: absolute;
    left: var(--space-4);
    top: 50%;
    transform: translateY(-50%);
    color: var(--color-text-muted);
    pointer-events: none;
  }

  .search-input {
    width: 100%;
    padding: var(--space-3) var(--space-4) var(--space-3) 2.75rem;
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
    font-size: 0.9375rem;
    background: var(--color-bg);
    color: var(--color-text);
    transition: border-color var(--transition-fast);
  }

  .search-input:focus {
    outline: none;
    border-color: var(--color-accent);
  }

  .filter-select {
    padding: var(--space-3) var(--space-4);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
    font-size: 0.9375rem;
    background: var(--color-bg);
    color: var(--color-text);
    cursor: pointer;
    transition: border-color var(--transition-fast);
    min-width: 150px;
  }

  .filter-select:hover,
  .filter-select:focus {
    outline: none;
    border-color: var(--color-accent);
  }

  .reset-btn {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    background: var(--color-bg);
    color: var(--color-text-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .reset-btn:hover {
    border-color: #ef4444;
    color: #ef4444;
  }

  .projects-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .project-item {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
    padding: var(--space-6);
    transition: border-color var(--transition-fast);
  }

  .project-item:hover {
    border-color: var(--color-accent);
  }

  .project-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-3);
  }

  .project-meta-left {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .category-badge {
    padding: var(--space-1) var(--space-3);
    background: transparent;
    color: var(--color-accent);
    border: 1px solid var(--color-accent);
    font-size: 0.75rem;
    font-weight: 600;
    border-radius: var(--border-radius);
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .featured-badge {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-1) var(--space-2);
    background: #fef3c7;
    color: #92400e;
    font-size: 0.6875rem;
    font-weight: 700;
    border-radius: var(--border-radius);
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .project-date {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    font-weight: 500;
    font-family: var(--font-sans);
  }

  .project-title {
    font-size: var(--step-1);
    font-weight: 700;
    margin-bottom: var(--space-2);
    line-height: 1.4;
  }

  .project-title a {
    color: var(--color-text);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .project-title a:hover {
    color: var(--color-accent);
  }

  .project-subtitle {
    font-size: 0.9375rem;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-3);
    font-weight: 500;
    line-height: 1.5;
  }

  .project-description {
    font-size: 0.9375rem;
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin-bottom: var(--space-4);
  }

  .conference-info {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    background: #fffbeb;
    border-left: 3px solid #f59e0b;
    font-size: 0.875rem;
    color: #78350f;
    margin-bottom: var(--space-4);
    border-radius: var(--border-radius);
  }

  .conference-info svg {
    flex-shrink: 0;
  }

  .project-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--space-4);
    padding-top: var(--space-4);
    border-top: 1px solid var(--color-border-light);
  }

  .tags-row {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .tag {
    padding: var(--space-1) var(--space-2);
    background: var(--color-surface);
    color: var(--color-text-secondary);
    font-size: 0.75rem;
    font-weight: 500;
    border-radius: var(--border-radius);
  }

  .view-link {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    color: var(--color-accent);
    font-weight: 600;
    font-size: 0.9375rem;
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .view-link:hover {
    color: var(--color-accent-hover);
  }

  .view-link svg {
    transition: transform var(--transition-fast);
  }

  .view-link:hover svg {
    transform: translateX(2px);
  }

  .no-results {
    text-align: center;
    padding: var(--space-16) var(--space-8);
  }

  .no-results svg {
    margin: 0 auto var(--space-6);
    color: var(--color-border);
  }

  .no-results p {
    color: var(--color-text-secondary);
    font-size: var(--step-0);
    margin-bottom: var(--space-4);
  }

  .reset-link {
    color: var(--color-accent);
    font-weight: 600;
    text-decoration: none;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 0.9375rem;
  }

  .reset-link:hover {
    text-decoration: underline;
  }

  @media (max-width: 1024px) {
    .projects-container {
      padding: var(--space-8) var(--space-6);
    }

    .page-title {
      font-size: var(--step-3);
    }

    .controls-bar {
      gap: var(--space-2);
    }

    .filter-select {
      min-width: 120px;
    }
  }

  @media (max-width: 768px) {
    .projects-container {
      padding: var(--space-6) var(--space-4);
    }

    .page-title {
      font-size: var(--step-2);
    }

    .stats-row {
      flex-direction: column;
      gap: var(--space-3);
      padding: var(--space-3) 0;
    }

    .stat-number {
      font-size: var(--step-1);
    }

    .controls-bar {
      flex-direction: column;
    }

    .search-box {
      width: 100%;
      min-width: auto;
    }

    .filter-select {
      width: 100%;
      min-width: auto;
    }

    .reset-btn {
      width: 100%;
      justify-content: center;
    }

    .project-item {
      padding: var(--space-4);
    }

    .project-title {
      font-size: var(--step-0);
    }

    .project-subtitle,
    .project-description {
      font-size: 0.875rem;
    }

    .project-footer {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-3);
    }

    .view-link {
      width: 100%;
      justify-content: center;
      padding: var(--space-3);
      background: var(--color-accent-light);
      border-radius: var(--border-radius);
    }
  }

  @media (max-width: 640px) {
    .projects-container {
      padding: var(--space-4) var(--space-3);
    }

    .page-title {
      font-size: var(--step-2);
    }

    .project-item {
      padding: var(--space-4);
    }

    .category-badge,
    .featured-badge {
      font-size: 0.625rem;
      padding: 0.2rem var(--space-2);
    }
  }
</style>

<script is:inline>
  function initProjectSearch() {
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const yearFilter = document.getElementById('yearFilter');
    const resetBtn = document.getElementById('resetBtn');
    const resetFromEmpty = document.getElementById('resetFromEmpty');
    const projectsList = document.getElementById('projectsList');
    const noResults = document.getElementById('noResults');

    if (!searchInput || !projectsList) return;

    function filterProjects() {
      const searchTerm = searchInput.value.toLowerCase();
      const category = categoryFilter.value;
      const year = yearFilter.value;

      const items = projectsList.querySelectorAll('.project-item');
      let visibleCount = 0;

      items.forEach(function(item) {
        const searchText = (item.dataset.searchText || '').toLowerCase();
        const itemCategory = item.dataset.category || '';
        const itemYear = item.dataset.year || '';

        const searchMatch = searchTerm === '' || searchText.includes(searchTerm);
        const categoryMatch = category === 'all' || itemCategory === category;
        const yearMatch = year === 'all' || itemYear === year;

        if (searchMatch && categoryMatch && yearMatch) {
          item.style.display = 'block';
          visibleCount++;
        } else {
          item.style.display = 'none';
        }
      });

      noResults.style.display = visibleCount === 0 ? 'block' : 'none';
    }

    function resetFilters() {
      searchInput.value = '';
      categoryFilter.value = 'all';
      yearFilter.value = 'all';
      filterProjects();
    }

    searchInput.addEventListener('input', filterProjects);
    categoryFilter.addEventListener('change', filterProjects);
    yearFilter.addEventListener('change', filterProjects);
    if (resetBtn) resetBtn.addEventListener('click', resetFilters);
    if (resetFromEmpty) resetFromEmpty.addEventListener('click', resetFilters);
  }

  document.addEventListener('astro:page-load', initProjectSearch);
</script>
