---
import BaseLayout from '../../layouts/BaseLayout.astro';
import projectsData from '../../data/projects.json';

export async function getStaticPaths() {
  const projects = projectsData.projects || [];
  return projects.map(project => ({
    params: { slug: project.id },
    props: { project }
  }));
}

const { project } = Astro.props;

// Load data for broadcasting project
let chartData = null;
if (project.id === 'broadcasting-revenue-2015-2024') {
  try {
    const fs = await import('fs/promises');
    const path = await import('path');
    const dataPath = path.join(process.cwd(), 'public', 'projects', 'broadcasting', 'net_inflow_summary.json');
    const data = await fs.readFile(dataPath, 'utf-8');
    chartData = JSON.parse(data);
  } catch (error) {
    console.error('Failed to load chart data:', error);
  }
}
---

<BaseLayout title={`${project.title} - Projects`} description={project.description}>
  <div class="project-detail">
    <header class="project-header">
      <div class="breadcrumb">
        <a href="/projects">Projects</a> / {project.title}
      </div>
      <h1 class="project-title">{project.title}</h1>
      <p class="project-title-en">{project.title_en}</p>
      {project.subtitle && (
        <>
          <p class="project-subtitle">{project.subtitle}</p>
          {project.subtitle_en && <p class="project-subtitle-en">{project.subtitle_en}</p>}
        </>
      )}

      <div class="project-meta">
        <span class="meta-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          {new Date(project.date).toLocaleDateString('ko-KR')}
        </span>
        <span class="meta-item category">{project.category}</span>
        {project.conference && (
          <span class="meta-item conference">{project.conference}</span>
        )}
        {project.verification_accuracy && (
          <span class="meta-item accuracy">
            검증 정확도: {project.verification_accuracy}
          </span>
        )}
      </div>
    </header>

    <div class="project-content">
      <section class="section">
        <h2 data-lang="en">Overview</h2>
        <h2 data-lang="ko">개요</h2>
        <p class="description">{project.description}</p>
        <p class="description-en">{project.description_en}</p>
      </section>

      {project.key_findings && (
        <section class="section key-findings-section">
          <h2 data-lang="en">Key Findings</h2>
          <h2 data-lang="ko">주요 발견사항</h2>
          <div class="findings-grid">
            {project.key_findings.map((finding, index) => (
              <div class="finding-card">
                <div class="finding-number">{index + 1}</div>
                <p>{finding}</p>
              </div>
            ))}
          </div>
        </section>
      )}

      {chartData && (
        <section class="section charts-section">
          <h2 data-lang="en">Data Visualization</h2>
          <h2 data-lang="ko">데이터 시각화</h2>

          <div class="chart-container">
            <h3 data-lang="en">10-Year Revenue Trend (2015-2024)</h3>
            <h3 data-lang="ko">10년간 재원 추이 (2015-2024)</h3>
            <canvas id="trendChart"></canvas>
          </div>

          <div class="chart-container">
            <h3 data-lang="en">Revenue Structure Comparison (2015 vs 2024)</h3>
            <h3 data-lang="ko">재원 구조 비교 (2015 vs 2024)</h3>
            <canvas id="comparisonChart"></canvas>
          </div>

          <div class="chart-container">
            <h3 data-lang="en">Revenue Breakdown by Source (2024)</h3>
            <h3 data-lang="ko">재원별 구성 (2024)</h3>
            <canvas id="pieChart"></canvas>
          </div>
        </section>
      )}

      {project.policy_proposals && project.policy_proposals.length > 0 && (
        <section class="section policy-section">
          <h2 data-lang="en">Policy Proposals</h2>
          <h2 data-lang="ko">정책 제안</h2>
          <div class="policy-grid">
            {project.policy_proposals.map((proposal, index) => (
              <div class="policy-card">
                <div class="policy-number">{index + 1}</div>
                <p>{proposal}</p>
              </div>
            ))}
          </div>
        </section>
      )}

      {project.technologies && (
        <section class="section">
          <h2 data-lang="en">Technologies Used</h2>
          <h2 data-lang="ko">사용 기술</h2>
          <div class="tech-tags">
            {project.technologies.map((tech) => (
              <span class="tech-tag">{tech}</span>
            ))}
          </div>
        </section>
      )}
    </div>
  </div>

  {chartData && (
    <>
      <script is:inline src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
      <script is:inline define:vars={{ chartData }}>
        // Trend Chart
        const trendCtx = document.getElementById('trendChart');
        if (trendCtx) {
          new Chart(trendCtx, {
            type: 'line',
            data: {
              labels: chartData.map(d => d.year + '년'),
              datasets: [
                {
                  label: '유료방송수신료',
                  data: chartData.map(d => d.subscription_fee),
                  borderColor: '#2563eb',
                  backgroundColor: 'rgba(37, 99, 235, 0.1)',
                  tension: 0.4
                },
                {
                  label: '방송광고',
                  data: chartData.map(d => d.broadcasting_ad),
                  borderColor: '#dc2626',
                  backgroundColor: 'rgba(220, 38, 38, 0.1)',
                  tension: 0.4
                },
                {
                  label: '홈쇼핑송출수수료',
                  data: chartData.map(d => d.homeshop_fee),
                  borderColor: '#16a34a',
                  backgroundColor: 'rgba(22, 163, 74, 0.1)',
                  tension: 0.4
                },
                {
                  label: 'KBS수신료',
                  data: chartData.map(d => d.kbs_fee),
                  borderColor: '#ca8a04',
                  backgroundColor: 'rgba(202, 138, 4, 0.1)',
                  tension: 0.4
                },
                {
                  label: '방발기금',
                  data: chartData.map(d => d.broadcast_fund),
                  borderColor: '#9333ea',
                  backgroundColor: 'rgba(147, 51, 234, 0.1)',
                  tension: 0.4
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  position: 'top',
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + '억원';
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return value.toLocaleString() + '억원';
                    }
                  }
                }
              }
            }
          });
        }

        // Comparison Chart
        const comparisonCtx = document.getElementById('comparisonChart');
        if (comparisonCtx) {
          const data2015 = chartData.find(d => d.year === 2015);
          const data2024 = chartData.find(d => d.year === 2024);

          new Chart(comparisonCtx, {
            type: 'bar',
            data: {
              labels: ['유료방송수신료', '방송광고', '홈쇼핑송출수수료', 'KBS수신료', '방발기금'],
              datasets: [
                {
                  label: '2015년',
                  data: [
                    data2015.subscription_fee,
                    data2015.broadcasting_ad,
                    data2015.homeshop_fee,
                    data2015.kbs_fee,
                    data2015.broadcast_fund
                  ],
                  backgroundColor: 'rgba(37, 99, 235, 0.7)',
                },
                {
                  label: '2024년',
                  data: [
                    data2024.subscription_fee,
                    data2024.broadcasting_ad,
                    data2024.homeshop_fee,
                    data2024.kbs_fee,
                    data2024.broadcast_fund
                  ],
                  backgroundColor: 'rgba(220, 38, 38, 0.7)',
                }
              ]
            },
            options: {
              responsive: true,
              plugins: {
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + '억원';
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return value.toLocaleString() + '억원';
                    }
                  }
                }
              }
            }
          });
        }

        // Pie Chart
        const pieCtx = document.getElementById('pieChart');
        if (pieCtx) {
          const data2024 = chartData.find(d => d.year === 2024);

          new Chart(pieCtx, {
            type: 'doughnut',
            data: {
              labels: ['유료방송수신료', '방송광고', '홈쇼핑송출수수료', 'KBS수신료', '방발기금'],
              datasets: [{
                data: [
                  data2024.subscription_fee,
                  data2024.broadcasting_ad,
                  data2024.homeshop_fee,
                  data2024.kbs_fee,
                  data2024.broadcast_fund
                ],
                backgroundColor: [
                  'rgba(37, 99, 235, 0.8)',
                  'rgba(220, 38, 38, 0.8)',
                  'rgba(22, 163, 74, 0.8)',
                  'rgba(202, 138, 4, 0.8)',
                  'rgba(147, 51, 234, 0.8)'
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: 'right',
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                      const percentage = ((context.parsed / total) * 100).toFixed(1);
                      return context.label + ': ' + context.parsed.toLocaleString() + '억원 (' + percentage + '%)';
                    }
                  }
                }
              }
            }
          });
        }
      </script>
    </>
  )}
</BaseLayout>

<style>
  .project-detail {
    max-width: 1200px;
    margin: 0 auto;
    padding: 3rem 1.5rem;
  }

  .project-header {
    margin-bottom: 3rem;
  }

  .breadcrumb {
    font-size: 0.875rem;
    color: #6b7280;
    margin-bottom: 1rem;
  }

  .breadcrumb a {
    color: #2563eb;
    text-decoration: none;
  }

  .breadcrumb a:hover {
    text-decoration: underline;
  }

  .project-title {
    font-size: 2.5rem;
    font-weight: 700;
    color: #1e40af;
    margin-bottom: 0.5rem;
    line-height: 1.2;
  }

  .project-title-en {
    font-size: 1.25rem;
    color: #6b7280;
    font-style: italic;
    margin-bottom: 0.5rem;
  }

  .project-subtitle {
    font-size: 1.125rem;
    color: #4b5563;
    font-weight: 500;
    margin-bottom: 0.5rem;
  }

  .project-subtitle-en {
    font-size: 1rem;
    color: #6b7280;
    font-style: italic;
    margin-bottom: 1.5rem;
  }

  .project-meta {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .meta-item {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.5rem 1rem;
    background: #f3f4f6;
    color: #4b5563;
    font-size: 0.875rem;
    border-radius: 0.25rem;
  }

  .meta-item svg {
    flex-shrink: 0;
  }

  .meta-item.category {
    background: #dbeafe;
    color: #1e40af;
    font-weight: 600;
  }

  .meta-item.conference {
    background: #dcfce7;
    color: #166534;
  }

  .meta-item.accuracy {
    background: #fef3c7;
    color: #92400e;
    font-weight: 600;
  }

  .project-content {
    display: flex;
    flex-direction: column;
    gap: 3rem;
  }

  .section h2 {
    font-size: 1.875rem;
    color: #1f2937;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e5e7eb;
  }

  .description,
  .description-en {
    font-size: 1.125rem;
    line-height: 1.7;
    color: #4b5563;
    margin-bottom: 1rem;
  }

  .description-en {
    font-style: italic;
    color: #6b7280;
  }

  .findings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
  }

  .finding-card {
    position: relative;
    padding: 1.5rem;
    padding-left: 4rem;
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border-left: 4px solid #2563eb;
    border-radius: 0.5rem;
  }

  .finding-number {
    position: absolute;
    top: 1.5rem;
    left: 1.5rem;
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #2563eb;
    color: white;
    font-weight: 700;
    border-radius: 50%;
    font-size: 1rem;
  }

  .finding-card p {
    color: #1f2937;
    font-weight: 500;
    line-height: 1.6;
  }

  .chart-container {
    background: white;
    padding: 2rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    margin-bottom: 2rem;
  }

  .chart-container h3 {
    font-size: 1.25rem;
    color: #1f2937;
    margin-bottom: 1.5rem;
  }

  .chart-container canvas {
    max-height: 400px;
  }

  .policy-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
  }

  .policy-card {
    position: relative;
    padding: 1.5rem;
    padding-left: 4rem;
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border-left: 4px solid #f59e0b;
    border-radius: 0.5rem;
  }

  .policy-number {
    position: absolute;
    top: 1.5rem;
    left: 1.5rem;
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f59e0b;
    color: white;
    font-weight: 700;
    border-radius: 50%;
    font-size: 1rem;
  }

  .policy-card p {
    color: #78350f;
    font-weight: 600;
    line-height: 1.6;
  }

  .tech-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .tech-tag {
    padding: 0.5rem 1.25rem;
    background: #f3f4f6;
    color: #1f2937;
    font-size: 0.875rem;
    font-weight: 500;
    border-radius: 9999px;
    border: 1px solid #d1d5db;
  }

  @media (max-width: 768px) {
    .project-title {
      font-size: 1.875rem;
    }

    .findings-grid {
      grid-template-columns: 1fr;
    }

    .chart-container {
      padding: 1rem;
    }
  }
</style>
