---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PublicationCard from '../../components/PublicationCard.astro';
import publicationsData from '../../data/publications.json';

const allPublications = await getCollection('publications');

const scholarStats = publicationsData.scholarStats || {
  citations: 0,
  hIndex: 0,
  i10Index: 0
};
const citationGraph = publicationsData.citationGraph || [];
const domesticPublications = publicationsData.domestic_publications || [];

// Convert markdown publications to same format as JSON
const publications = allPublications.map(pub => ({
  id: pub.slug,
  ...pub.data,
}));

// Group by status
const workInProgress = publications
  .filter(p => p.status === 'work-in-progress')
  .sort((a, b) => b.year - a.year);

const workingPapers = publications
  .filter(p => p.status === 'working-paper')
  .sort((a, b) => b.year - a.year);

const publishedPapers = publications
  .filter(p => p.status === 'published')
  .sort((a, b) => b.year - a.year);

// Sort domestic publications by citations (descending)
const domesticPapers = domesticPublications
  .sort((a, b) => b.citations - a.citations);

const pageTitle = "Research - Yonghee Kim";

// Current date
const currentDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
---

<BaseLayout title={pageTitle}>
  <style>
    .research-container {
      max-width: var(--container-max);
      margin: 0 auto;
      padding: var(--space-16) var(--space-8);
      line-height: 1.625;
    }

    /* Header */
    .page-header {
      margin-bottom: var(--space-12);
    }

    .page-title {
      font-family: var(--font-serif);
      font-size: var(--step-3);
      font-weight: 400;
      color: var(--color-text);
      margin-bottom: var(--space-2);
    }

    .page-description {
      font-size: var(--step-0);
      color: var(--color-text-secondary);
      line-height: 1.6;
    }

    /* Scholar Stats - compact inline */
    .scholar-stats-line {
      font-size: 0.875rem;
      color: var(--color-text-muted);
      margin-bottom: var(--space-8);
      line-height: 1.6;
    }

    .scholar-stats-line a {
      color: var(--color-accent);
      text-decoration: none;
      transition: color var(--transition-fast);
    }

    .scholar-stats-line a:hover {
      color: var(--color-accent-hover);
      text-decoration: underline;
    }

    .stats-separator {
      margin: 0 var(--space-2);
      color: var(--color-border);
    }

    .stat-dot {
      margin: 0 var(--space-1);
      color: var(--color-text-muted);
    }

    /* Citation Graph */
    .citation-graph {
      margin-bottom: var(--space-12);
    }

    .graph-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-4);
    }

    #citationChart {
      max-height: 200px;
    }

    .stat-updated {
      font-size: 0.8125rem;
      color: var(--color-text-muted);
      margin-top: var(--space-3);
    }

    /* Section Divider */
    hr {
      border: none;
      border-top: 1px solid var(--color-border-light);
      margin: var(--space-12) 0;
    }

    /* Sort Controls */
    .sort-controls {
      display: flex;
      gap: var(--space-3);
      margin-bottom: var(--space-8);
      align-items: center;
      flex-wrap: wrap;
    }

    .sort-label {
      font-size: 0.875rem;
      color: var(--color-text-muted);
      font-weight: 500;
    }

    .sort-button {
      padding: var(--space-2) var(--space-4);
      border: 1px solid var(--color-border);
      background: var(--color-bg);
      border-radius: var(--border-radius);
      font-size: 0.875rem;
      cursor: pointer;
      transition: all var(--transition-fast);
      color: var(--color-text-secondary);
    }

    .sort-button:hover {
      border-color: var(--color-accent);
      color: var(--color-accent);
    }

    .sort-button.active {
      background: var(--color-text);
      color: var(--color-bg);
      border-color: var(--color-text);
    }

    /* Section Styles */
    .research-section {
      margin-bottom: var(--space-12);
    }

    .section-title {
      font-family: var(--font-serif);
      font-size: var(--step-2);
      font-weight: 400;
      color: var(--color-text);
      margin-bottom: var(--space-2);
    }

    .section-description {
      font-size: 0.9375rem;
      color: var(--color-text-muted);
      margin-bottom: var(--space-8);
    }

    .publication-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-8);
    }

    /* Domestic Publications */
    .domestic-pub-item {
      padding-bottom: var(--space-6);
      border-bottom: 1px solid var(--color-border-light);
      margin-bottom: var(--space-2);
    }

    .domestic-pub-item:last-child {
      border-bottom: none;
    }

    .pub-header {
      margin-bottom: var(--space-3);
    }

    .pub-title-ko {
      font-size: 1.0625rem;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: var(--space-1);
      line-height: 1.5;
    }

    .pub-title-en {
      font-size: 0.9375rem;
      color: var(--color-text-muted);
      font-style: italic;
      margin: 0;
    }

    .pub-meta {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: var(--space-2);
      font-size: 0.875rem;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-3);
    }

    .pub-authors {
      font-weight: 500;
    }

    .pub-separator {
      color: var(--color-text-muted);
    }

    .pub-journal-ko {
      font-weight: 500;
      color: var(--color-accent);
    }

    .pub-journal-en {
      color: var(--color-text-muted);
      font-size: 0.8125rem;
    }

    .pub-abstract {
      background: var(--color-surface);
      padding: var(--space-4);
      border-left: 2px solid var(--color-border);
      border-radius: var(--border-radius);
      font-size: 0.875rem;
      color: var(--color-text-secondary);
      line-height: 1.6;
      margin-bottom: var(--space-3);
    }

    .pub-footer {
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }

    .pub-badge {
      display: inline-block;
      padding: var(--space-1) var(--space-3);
      font-size: 0.75rem;
      font-weight: 600;
      border-radius: var(--border-radius);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .pub-badge-kci {
      background: var(--color-accent-light);
      color: var(--color-accent);
    }

    .pub-citations {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      font-size: 0.875rem;
      color: var(--color-text-muted);
    }

    .pub-citations svg {
      flex-shrink: 0;
    }

    /* Responsive */
    @media (max-width: 640px) {
      .research-container {
        padding: var(--space-8) var(--space-4);
      }

      .pub-title-ko {
        font-size: 1rem;
      }

      .pub-meta {
        font-size: 0.8125rem;
      }

      .scholar-stats-line {
        line-height: 1.8;
      }
    }
  </style>

  <div class="research-container">
    <!-- Header -->
    <header class="page-header">
      <h1 class="page-title">Research</h1>
      <p class="page-description">
        Academic research in media policy, digital platform regulation, and media economics.
      </p>
    </header>

    <!-- Scholar Stats - compact single line -->
    <div class="scholar-stats-line">
      <span>
        <a href="https://scholar.google.com/citations?user=semkeskAAAAJ" target="_blank">Google Scholar</a>:
        {scholarStats.citations} citations
        <span class="stat-dot">&middot;</span>
        h-index: {scholarStats.hIndex}
        <span class="stat-dot">&middot;</span>
        i10-index: {scholarStats.i10Index}
        <span class="stats-separator">|</span>
        <a href="https://orcid.org/0000-0002-5643-2748" target="_blank">ORCID</a>: 0000-0002-5643-2748
      </span>
    </div>

    <!-- Citation Graph -->
    {citationGraph.length > 0 && (
      <div class="citation-graph">
        <h3 class="graph-title">Citations by Year</h3>
        <canvas id="citationChart"></canvas>
        <p class="stat-updated">Last updated: {currentDate}</p>
      </div>
    )}

    <hr />

    <!-- Published Papers -->
    <section class="research-section">
      <h2 class="section-title">Published Papers</h2>
      <p class="section-description">Peer-reviewed publications in academic journals</p>

      <div class="sort-controls">
        <span class="sort-label">Sort by:</span>
        <button class="sort-button active" data-sort="year">Year (newest)</button>
        <button class="sort-button" data-sort="citations">Citations (highest)</button>
      </div>

      <div class="publication-list" id="publication-list">
        {publishedPapers.map((pub) => (
          <div class="publication-item" data-year={pub.year} data-citations={pub.citations || 0}>
            <PublicationCard
              publication={pub}
              variant="full"
              showAbstract={true}
              showBadges={true}
              showLinks={true}
            />
          </div>
        ))}
      </div>
    </section>

    <hr />

    <!-- Work in Progress -->
    {workInProgress.length > 0 && (
      <>
        <section class="research-section">
          <h2 class="section-title">Work in Progress</h2>
          <p class="section-description">Research projects currently under development</p>
          <div class="publication-list">
            {workInProgress.map((pub) => (
              <PublicationCard
                publication={pub}
                variant="full"
                showAbstract={true}
                showBadges={true}
                showLinks={false}
              />
            ))}
          </div>
        </section>
        <hr />
      </>
    )}

    <!-- Working Papers -->
    {workingPapers.length > 0 && (
      <>
        <section class="research-section">
          <h2 class="section-title">Working Papers</h2>
          <p class="section-description">Research papers under review or revision</p>
          <div class="publication-list">
            {workingPapers.map((pub) => (
              <PublicationCard
                publication={pub}
                variant="full"
                showAbstract={true}
                showBadges={true}
                showLinks={false}
              />
            ))}
          </div>
        </section>
        <hr />
      </>
    )}

    <!-- Domestic Publications (Korean) -->
    {domesticPapers.length > 0 && (
      <section class="research-section">
        <h2 class="section-title">Domestic Publications (Korean)</h2>
        <p class="section-description">Publications in Korean academic journals (KCI)</p>
        <div class="publication-list">
          {domesticPapers.map((pub) => (
            <div class="domestic-pub-item">
              <div class="pub-header">
                <h3 class="pub-title-ko">{pub.title}</h3>
                {pub.title_en && <p class="pub-title-en">{pub.title_en}</p>}
              </div>
              <div class="pub-meta">
                <span class="pub-authors">{pub.authors.join(', ')}</span>
                <span class="pub-separator">&middot;</span>
                <span class="pub-journal-ko">{pub.journal}</span>
                {pub.journal_en && <span class="pub-journal-en">({pub.journal_en})</span>}
                <span class="pub-separator">&middot;</span>
                <span class="pub-year">{pub.year}</span>
                {pub.volume && <span class="pub-volume"> {pub.volume}({pub.issue})</span>}
                {pub.pages && <span class="pub-pages">, {pub.pages}</span>}
              </div>
              {pub.abstract && (
                <div class="pub-abstract">{pub.abstract}</div>
              )}
              <div class="pub-footer">
                <span class="pub-badge pub-badge-kci">KCI</span>
                {pub.citations > 0 && (
                  <span class="pub-citations">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                      <path d="M14 2v6h6"></path>
                      <line x1="16" y1="13" x2="8" y2="13"></line>
                      <line x1="16" y1="17" x2="8" y2="17"></line>
                      <line x1="10" y1="9" x2="8" y2="9"></line>
                    </svg>
                    {pub.citations} citations
                  </span>
                )}
              </div>
            </div>
          ))}
        </div>
      </section>
    )}
  </div>

  <!-- Chart.js -->
  <script is:inline src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

  <script is:inline define:vars={{ citationGraph }}>
    var _citationGraph = citationGraph;
    var _citationChartInstance = null;

    function initPublicationsPage() {
      // Citation Graph
      if (_citationGraph && _citationGraph.length > 0) {
        var ctx = document.getElementById('citationChart');
        if (ctx) {
          if (_citationChartInstance) {
            _citationChartInstance.destroy();
          }
          var rootStyles = getComputedStyle(document.documentElement);
          var accentColor = rootStyles.getPropertyValue('--color-accent').trim() || '#0055aa';
          var borderColor = rootStyles.getPropertyValue('--color-border').trim() || '#e0e0e0';
          var textMuted = rootStyles.getPropertyValue('--color-text-muted').trim() || '#888888';

          _citationChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: _citationGraph.map(function(d) { return d.year; }),
              datasets: [{
                label: 'Citations',
                data: _citationGraph.map(function(d) { return d.citations; }),
                backgroundColor: accentColor + '55',
                borderColor: accentColor,
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { precision: 0, color: textMuted },
                  grid: { color: borderColor }
                },
                x: {
                  ticks: { color: textMuted },
                  grid: { display: false }
                }
              }
            }
          });
        }
      }

      // Sorting functionality
      var sortButtons = document.querySelectorAll('.sort-button');
      var publicationList = document.getElementById('publication-list');

      if (publicationList) {
        sortButtons.forEach(function(button) {
          button.addEventListener('click', function() {
            sortButtons.forEach(function(btn) { btn.classList.remove('active'); });
            button.classList.add('active');

            var sortType = button.dataset.sort;
            var items = Array.from(publicationList.querySelectorAll('.publication-item'));

            items.sort(function(a, b) {
              if (sortType === 'year') {
                return parseInt(b.dataset.year) - parseInt(a.dataset.year);
              } else if (sortType === 'citations') {
                return parseInt(b.dataset.citations) - parseInt(a.dataset.citations);
              }
              return 0;
            });

            items.forEach(function(item) {
              publicationList.appendChild(item);
            });
          });
        });
      }
    }

    document.addEventListener('astro:page-load', initPublicationsPage);
  </script>
</BaseLayout>
