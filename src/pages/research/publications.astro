---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PublicationCard from '../../components/PublicationCard.astro';
import StatItem from '../../components/StatItem.astro';
import publicationsData from '../../data/publications.json';

// Fetch markdown publications
const allPublications = await getCollection('publications');

// Get scholarStats and citationGraph from JSON
const scholarStats = publicationsData.scholarStats || {
  citations: 0,
  hIndex: 0,
  i10Index: 0
};
const citationGraph = publicationsData.citationGraph || [];
const domesticPublications = publicationsData.domestic_publications || [];

// Convert markdown publications to JSON format
const publications = allPublications.map(pub => ({
  id: pub.slug,
  ...pub.data,
}));

// Group by status
const workInProgress = publications
  .filter(p => p.status === 'work-in-progress')
  .sort((a, b) => b.year - a.year);

const workingPapers = publications
  .filter(p => p.status === 'working-paper')
  .sort((a, b) => b.year - a.year);

const publishedPapers = publications
  .filter(p => p.status === 'published')
  .sort((a, b) => b.year - a.year);

// Sort domestic papers by citations
const domesticPapers = domesticPublications
  .sort((a, b) => b.citations - a.citations);

const pageTitle = "Research - Yonghee Kim";

// Current date
const currentDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
---

<BaseLayout title={pageTitle}>
  <div class="research-container">
    <header class="page-header">
      <h1 class="page-title">Research</h1>
      <p class="page-description">
        Academic research in media policy, digital platform regulation, and media economics.
      </p>
    </header>

    <div class="profiles-grid">
      <section class="scholar-section">
        <div class="scholar-header">
          <h2 class="scholar-title">Google Scholar</h2>
          <a href="https://scholar.google.com/citations?user=semkeskAAAAJ" target="_blank" class="scholar-link">
            View Profile →
          </a>
        </div>
        <div class="scholar-stats">
          <StatItem
            value={scholarStats.citations}
            label="Citations"
            sublabel="All time"
            align="center"
          />
          <StatItem
            value={scholarStats.hIndex}
            label="h-index"
            sublabel="All time"
            align="center"
          />
          <StatItem
            value={scholarStats.i10Index}
            label="i10-index"
            sublabel="All time"
            align="center"
          />
        </div>

        {citationGraph.length > 0 && (
          <div class="citation-graph">
            <h3 class="graph-title">Citations by Year</h3>
            <canvas id="citationChart"></canvas>
          </div>
        )}

        <p class="stat-updated">Last updated: {currentDate}</p>
      </section>

      <section class="orcid-section">
        <div class="scholar-header">
          <h2 class="scholar-title">ORCID</h2>
          <a href="https://orcid.org/0000-0002-5643-2748" target="_blank" class="scholar-link">
            View Profile →
          </a>
        </div>

        <div class="orcid-content">
          <div class="orcid-id-display">
            <div class="orcid-id-label">Verified Researcher ID</div>
            <div class="orcid-id-value">0000-0002-5643-2748</div>
          </div>

          <div class="orcid-info">
            <div class="orcid-info-item">
              <div class="orcid-info-label">Official Registry</div>
              <div class="orcid-info-text">Persistent digital identifier for researchers</div>
            </div>
            <div class="orcid-info-item">
              <div class="orcid-info-label">ResearcherID</div>
              <div class="orcid-info-text">G-5295-2018</div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <hr class="section-divider" />

    <section class="research-section">
      <h2 class="section-title">Published Papers</h2>
      <p class="section-description">Peer-reviewed publications in academic journals</p>

      <div class="sort-controls">
        <span class="sort-label">Sort by:</span>
        <button class="sort-button active" data-sort="year">Year (newest)</button>
        <button class="sort-button" data-sort="citations">Citations (highest)</button>
      </div>

      <div class="publication-list" id="publication-list">
        {publishedPapers.map((pub) => (
          <div class="publication-item" data-year={pub.year} data-citations={pub.citations || 0}>
            <PublicationCard
              publication={pub}
              variant="full"
              showAbstract={true}
              showBadges={true}
              showLinks={true}
            />
          </div>
        ))}
      </div>
    </section>

    <hr class="section-divider" />

    {workInProgress.length > 0 && (
      <>
        <section class="research-section">
          <h2 class="section-title">Work in Progress</h2>
          <p class="section-description">Research projects currently under development</p>
          <div class="publication-list">
            {workInProgress.map((pub) => (
              <PublicationCard
                publication={pub}
                variant="full"
                showAbstract={true}
                showBadges={true}
                showLinks={false}
              />
            ))}
          </div>
        </section>
        <hr class="section-divider" />
      </>
    )}

    {workingPapers.length > 0 && (
      <>
        <section class="research-section">
          <h2 class="section-title">Working Papers</h2>
          <p class="section-description">Research papers under review or revision</p>
          <div class="publication-list">
            {workingPapers.map((pub) => (
              <PublicationCard
                publication={pub}
                variant="full"
                showAbstract={true}
                showBadges={true}
                showLinks={false}
              />
            ))}
          </div>
        </section>
        <hr class="section-divider" />
      </>
    )}

    {domesticPapers.length > 0 && (
      <section class="research-section">
        <h2 class="section-title">Domestic Publications (Korean)</h2>
        <p class="section-description">Publications in Korean academic journals (KCI)</p>
        <div class="publication-list">
          {domesticPapers.map((pub) => (
            <div class="domestic-pub-item">
              <div class="pub-header">
                <h3 class="pub-title-ko">{pub.title}</h3>
                {pub.title_en && <p class="pub-title-en">{pub.title_en}</p>}
              </div>
              <div class="pub-meta">
                <span class="pub-authors">{pub.authors.join(', ')}</span>
                <span class="pub-separator">•</span>
                <span class="pub-journal">{pub.journal}</span>
                <span class="pub-separator">•</span>
                <span class="pub-year">{pub.year}</span>
                {pub.volume && <span class="pub-volume"> {pub.volume}({pub.issue})</span>}
                {pub.pages && <span class="pub-pages">, {pub.pages}</span>}
              </div>
              {pub.abstract && (
                <div class="pub-abstract">{pub.abstract}</div>
              )}
              <div class="pub-footer">
                <span class="pub-badge">KCI</span>
                {pub.citations > 0 && (
                  <span class="pub-citations">{pub.citations} citations</span>
                )}
              </div>
            </div>
          ))}
        </div>
      </section>
    )}
  </div>

  <script is:inline src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

  <script is:inline define:vars={{ citationGraph }}>
    if (citationGraph && citationGraph.length > 0) {
      const ctx = document.getElementById('citationChart');
      if (ctx) {
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: citationGraph.map(d => d.year),
            datasets: [{
              label: 'Citations',
              data: citationGraph.map(d => d.citations),
              backgroundColor: 'rgba(30, 64, 175, 0.7)',
              borderColor: 'rgba(30, 64, 175, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0
                }
              }
            }
          }
        });
      }
    }

    const sortButtons = document.querySelectorAll('.sort-button');
    const publicationList = document.getElementById('publication-list');

    sortButtons.forEach(button => {
      button.addEventListener('click', () => {
        sortButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');

        const sortType = button.dataset.sort;
        const items = Array.from(publicationList.querySelectorAll('.publication-item'));

        items.sort((a, b) => {
          if (sortType === 'year') {
            return parseInt(b.dataset.year) - parseInt(a.dataset.year);
          } else if (sortType === 'citations') {
            return parseInt(b.dataset.citations) - parseInt(a.dataset.citations);
          }
          return 0;
        });

        items.forEach(item => {
          publicationList.appendChild(item);
        });
      });
    });
  </script>
</BaseLayout>

<style>
  .research-container {
    max-width: 720px;
    margin: 0 auto;
    padding: 0 2rem;
  }

  .page-header {
    margin-bottom: 2rem;
  }

  .page-title {
    font-family: var(--font-heading);
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-text);
    margin: 0 0 0.5rem 0;
  }

  .page-description {
    font-size: 1rem;
    color: var(--color-text-secondary);
    margin: 0;
  }

  .profiles-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  @media (min-width: 768px) {
    .profiles-grid {
      grid-template-columns: 1fr 1fr;
    }
  }

  .scholar-section,
  .orcid-section {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
    padding: 1.5rem;
  }

  .scholar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .scholar-title {
    font-family: var(--font-heading);
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--color-text);
    margin: 0;
  }

  .scholar-link {
    color: var(--color-link);
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .scholar-link:hover {
    text-decoration: underline;
  }

  .scholar-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
  }

  .stat-updated {
    font-size: 0.75rem;
    color: var(--color-text-secondary);
    text-align: center;
    margin-top: 1rem;
  }

  .citation-graph {
    margin-top: 1.5rem;
    padding: 1rem;
    background: var(--color-bg);
    border-radius: 0.5rem;
    border: 1px solid var(--color-border);
  }

  .graph-title {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--color-text);
    margin: 0 0 0.75rem 0;
  }

  #citationChart {
    max-height: 200px;
  }

  .orcid-content {
    margin-top: 1rem;
  }

  .orcid-id-display {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
    padding: 1rem;
    text-align: center;
    margin-bottom: 1rem;
  }

  .orcid-id-label {
    font-size: 0.75rem;
    color: var(--color-text-secondary);
    font-weight: 600;
    margin-bottom: 0.25rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .orcid-id-value {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text);
    font-family: monospace;
  }

  .orcid-info {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .orcid-info-item {
    padding: 0.75rem;
    background: var(--color-bg);
    border-radius: 0.5rem;
    border: 1px solid var(--color-border);
  }

  .orcid-info-label {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: 0.125rem;
  }

  .orcid-info-text {
    font-size: 0.75rem;
    color: var(--color-text-secondary);
  }

  .section-divider {
    border: none;
    border-top: 1px solid var(--color-border);
    margin: 2rem 0;
  }

  .research-section {
    margin-bottom: 2rem;
  }

  .section-title {
    font-family: var(--font-heading);
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-text);
    margin: 0 0 0.25rem 0;
  }

  .section-description {
    font-size: 0.9375rem;
    color: var(--color-text-secondary);
    margin: 0 0 1.5rem 0;
  }

  .sort-controls {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    align-items: center;
    flex-wrap: wrap;
  }

  .sort-label {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    font-weight: 500;
  }

  .sort-button {
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--color-border);
    background: var(--color-bg);
    border-radius: 0.25rem;
    font-size: 0.8125rem;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--color-text-secondary);
  }

  .sort-button:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .sort-button.active {
    background: var(--color-accent);
    color: white;
    border-color: var(--color-accent);
  }

  .publication-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .domestic-pub-item {
    padding: 1.25rem;
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
  }

  .pub-header {
    margin-bottom: 0.75rem;
  }

  .pub-title-ko {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-text);
    margin: 0 0 0.25rem 0;
    line-height: 1.4;
  }

  .pub-title-en {
    font-size: 0.9375rem;
    color: var(--color-text-secondary);
    font-style: italic;
    margin: 0;
  }

  .pub-meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8125rem;
    color: var(--color-text-secondary);
    margin-bottom: 0.75rem;
  }

  .pub-authors {
    font-weight: 500;
  }

  .pub-separator {
    color: var(--color-border);
  }

  .pub-journal {
    font-weight: 500;
    color: var(--color-link);
  }

  .pub-abstract {
    background: var(--color-bg-secondary);
    padding: 0.75rem;
    border-left: 3px solid var(--color-accent);
    border-radius: 0.25rem;
    font-size: 0.8125rem;
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin-bottom: 0.75rem;
  }

  .pub-footer {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .pub-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    font-size: 0.6875rem;
    font-weight: 600;
    border-radius: 0.25rem;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    background: var(--color-bg-secondary);
    color: var(--color-accent);
    border: 1px solid var(--color-border);
  }

  .pub-citations {
    font-size: 0.8125rem;
    color: var(--color-text-secondary);
  }

  @media (max-width: 768px) {
    .research-container {
      padding: 0 1rem;
    }

    .page-title {
      font-size: 1.75rem;
    }

    .scholar-stats {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (max-width: 640px) {
    .page-title {
      font-size: 1.5rem;
    }

    .section-title {
      font-size: 1.25rem;
    }
  }
</style>
